name: Expire demo repository

on:
  schedule:
    # Daily check (UTC)
    - cron: "0 13 * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  expire-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read expiration date from deploy_all.sql
        id: expiry
        shell: bash
        run: |
          set -euo pipefail

          expires="$(
            grep -E 'EXPIRES:\s*[0-9]{4}-[0-9]{2}-[0-9]{2}' deploy_all.sql \
              | head -1 \
              | sed -E 's/.*EXPIRES:\s*([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/'
          )"

          if [[ -z "$expires" ]]; then
            echo "ERROR: Could not parse EXPIRES: YYYY-MM-DD from deploy_all.sql header" >&2
            exit 1
          fi

          today="$(date -u +%Y-%m-%d)"
          exp_ts="$(date -u -d "$expires" +%s)"
          now_ts="$(date -u -d "$today" +%s)"
          days_remaining="$(( (exp_ts - now_ts) / 86400 ))"

          echo "expires=$expires" >> "$GITHUB_OUTPUT"
          echo "today=$today" >> "$GITHUB_OUTPUT"
          echo "days_remaining=$days_remaining" >> "$GITHUB_OUTPUT"

      - name: Create warning issue (expiring soon)
        if: ${{ steps.expiry.outputs.days_remaining <= 7 && steps.expiry.outputs.days_remaining >= 0 }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const expires = '${{ steps.expiry.outputs.expires }}'
            const daysRemaining = Number('${{ steps.expiry.outputs.days_remaining }}')
            const owner = context.repo.owner
            const repo = context.repo.repo

            const title = `Demo expires on ${expires} (${daysRemaining} days remaining)`
            const body = [
              `This demo repository is scheduled to expire on **${expires}**.`,
              ``,
              `- Deployment is blocked after expiration by \`deploy_all.sql\`.`,
              `- If you still need this demo, extend the expiration by updating the **EXPIRES** line in \`deploy_all.sql\` (single source of truth).`,
              `- If this repo is public, archive it after expiration to reduce stale-demo discovery.`,
            ].join('\n')

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
            })

            const existing = openIssues.find((i) => i.title === title)
            if (existing) {
              core.info(`Issue already exists: #${existing.number}`)
              return
            }

            await github.rest.issues.create({ owner, repo, title, body })

      - name: Create expiration issue (expired)
        if: ${{ steps.expiry.outputs.days_remaining < 0 }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const expires = '${{ steps.expiry.outputs.expires }}'
            const owner = context.repo.owner
            const repo = context.repo.repo

            const title = `Demo expired on ${expires}`
            const body = [
              `This demo repository expired on **${expires}**.`,
              ``,
              `Recommended next actions:`,
              `- Archive the repository to prevent stale-demo discovery.`,
              `- If needed, fork and refresh: update the **EXPIRES** line in \`deploy_all.sql\` and validate syntax against current docs.`,
            ].join('\n')

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
            })

            const existing = openIssues.find((i) => i.title === title)
            if (existing) {
              core.info(`Issue already exists: #${existing.number}`)
              return
            }

            await github.rest.issues.create({ owner, repo, title, body })

      - name: Archive + make private (requires MASTER_PAT)
        if: ${{ steps.expiry.outputs.days_remaining < 0 && secrets.MASTER_PAT != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MASTER_PAT }}
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo

            await github.rest.repos.update({ owner, repo, archived: true })

            // Making a repo private may be restricted by org policy; attempt and continue if denied.
            try {
              await github.rest.repos.update({ owner, repo, private: true })
            } catch (err) {
              core.warning(`Could not make repository private: ${err.message}`)
            }
