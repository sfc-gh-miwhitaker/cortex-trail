name: Expire Demo Repository

on:
  schedule:
    # Daily check; will archive and attempt to make private after the expiration date in deploy_all.sql
    - cron: "15 3 * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write
  metadata: read
  administration: write

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine expiration date
        id: exp
        shell: bash
        run: |
          set -euo pipefail
          exp_line="$(grep -E "EXPIRES:\\s*[0-9]{4}-[0-9]{2}-[0-9]{2}" -m 1 deploy_all.sql || true)"
          if [[ -z "${exp_line}" ]]; then
            echo "Could not find EXPIRES: YYYY-MM-DD in deploy_all.sql"
            exit 1
          fi

          exp_date="$(echo "${exp_line}" | grep -Eo "[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -n 1)"
          today="$(date -u +%F)"

          if [[ "${today}" > "${exp_date}" ]]; then
            echo "expired=true" >> "$GITHUB_OUTPUT"
          else
            echo "expired=false" >> "$GITHUB_OUTPUT"
          fi

          echo "exp_date=${exp_date}" >> "$GITHUB_OUTPUT"
          echo "today=${today}" >> "$GITHUB_OUTPUT"

      - name: Create expiration issue (if expired)
        if: steps.exp.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const expDate = "${{ steps.exp.outputs.exp_date }}";
            const today = "${{ steps.exp.outputs.today }}";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `Demo expired (${expDate})`;
            const body = [
              `This demo repository is past its expiration date.`,
              ``,
              `- Expires: ${expDate}`,
              `- Today (UTC): ${today}`,
              ``,
              `Expected action: archive the repository and make it private (if permitted).`
            ].join("\n");
            try {
              await github.rest.issues.create({ owner, repo, title, body });
            } catch (e) {
              core.warning(`Unable to create issue (may already exist or permissions): ${e.message}`);
            }

      - name: Archive and make private (best effort)
        if: steps.exp.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            try {
              await github.rest.repos.update({ owner, repo, archived: true, private: true });
            } catch (e) {
              core.warning(`Unable to archive/make private (permissions may not allow): ${e.message}`);
            }
