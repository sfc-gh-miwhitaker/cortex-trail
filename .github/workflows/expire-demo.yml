# Demo Expiration Workflow
# Author: SE Community
# Purpose: Automatically archive and make private after expiration date
# Last Updated: 2025-12-02

name: Demo Expiration Check

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger

env:
  EXPIRE_DATE: '2025-12-25'

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Check expiration date
        id: check
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          EXPIRE_DATE="${{ env.EXPIRE_DATE }}"
          
          echo "Current date: $CURRENT_DATE"
          echo "Expiration date: $EXPIRE_DATE"
          
          if [[ "$CURRENT_DATE" > "$EXPIRE_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "üö´ Demo has expired!"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Demo is still active"
          fi

      - name: Archive repository
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('üö´ Demo expired - archiving repository...');
            
            // Archive the repository
            await github.rest.repos.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              archived: true
            });
            
            console.log('‚úÖ Repository archived successfully');
            
            // Note: Making repo private requires admin token with additional permissions
            // For security, we only archive. Manual intervention required for private.
            console.log('‚ö†Ô∏è  Manual action needed: Make repository private via Settings');

      - name: Create expiration notice issue
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö´ Demo Expired - Repository Archived',
              body: `## Demo Expiration Notice
              
            This demonstration repository has reached its expiration date (**${{ env.EXPIRE_DATE }}**) and has been automatically archived.
            
            ### Why demos expire
            - Prevents outdated code examples from being discovered and deployed
            - Ensures demos reflect current Snowflake features and syntax
            - Protects users from deprecated patterns and best practices drift
            
            ### Need an updated version?
            1. Contact SE Community for the latest version
            2. Or fork and update the expiration date and review for current syntax
            
            ### Repository Status
            - **Status:** Archived (read-only)
            - **Expiration Date:** ${{ env.EXPIRE_DATE }}
            - **Archived On:** ${new Date().toISOString().split('T')[0]}
            
            ---
            *This issue was created automatically by the demo expiration workflow.*`,
              labels: ['expired', 'automated']
            });
            
            console.log(`Created issue #${issue.data.number}`);
